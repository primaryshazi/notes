# IO多路复用

select，poll，epoll都是IO多路复用的机制。I/O多路复用就通过一种机制，可以监视多个描述符，一旦某个描述符就绪（一般是读就绪或者写就绪），能够通知程序进行相应的读写操作。但select，poll，epoll本质上都是同步I/O，因为他们都需要在读写事件就绪后自己负责进行读写，也就是说这个读写过程是阻塞的

---

## select

### select函数

> int select(int maxfdp, fd_set *readfds, fd_set *writefds, fd_set*errorfds, struct timeval *timeout);

1. maxfdp：监控的文件描述符的个数（文件描述符从0开始），即所有文件描述符的最大值加1
2. readfds writefds errorfds：可以理解为一个集合，这个集合中存放的是文件描述符
3. timeout：阻塞select超时时间
4. 返回值大于0则表示有返回值数量的文件描述符可读写，返回值等于0则表示没有变化，返回值小于0则表示出现错误

### select处理方式

1. 监控需要的文件描述符
2. 若返回有描述符可读写，则遍历[0, maxfdp)，对每一个可读写的文件描述符进行处理

### select模型特点

1. 文件描述符个数有限，取决于系统，一般为1024
2. 效率较低，只有少量文件描述符就绪后，每次处理需要遍历所有的文件描述符
3. 大量的文件描述符的数组被整体复制于用户态和内核地址空间之间

---

## poll

---

### poll函数

> int poll(struct pollfd *fds, unsigned int nfds, int timeout);

1. fds：被监视的文件描述符和发生事件结构体的数组
2. nfds：监视的结构体的数量
3. timeout：超时毫秒时间，-1表示永久阻塞
4. 返回值大于0则表示有返回值数量的文件描述符可读写，返回值等于0则表示没有变化，返回值小于0则表示出现错误

### poll处理方式

1. 监控需要的文件描述符
2. 若返回有描述符可读写，则遍历fds结构数组，对指定事件的描述符进行处理

### poll模型特点

1. poll服务器监视的文件描述符无上限
2. 效率较低，只有少量文件描述符就绪后，每次处理需要遍历所有的结构体
3. 大量的文件描述符的数组被整体复制于用户态和内核地址空间之间

---

## epoll

### epoll函数

> int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout);

1. epfd：创建的epoll操作描述符
2. events：若有事件发生，返回发生事件的结构体
3. maxevents：监听事件的最大个数，与创建数相同
4. timeout：超时时间

### epoll处理方式

1. 监控需要的文件描述符
2. 若返回有描述符可读写，则遍历时间结构体的前N个即可

### epoll模型特点

1. epoll服务器监视的文件描述符无上限
2. 效率较高，只需要遍历处理发生事件的文件描述符
3. 只有发生事件的文件描述符数组复制于用户态和内核地址空间之间

---

## 问题

### epoll是同步还是异步

从IO层面来看，epoll绝对是同步的；从消息处理层面来看，epoll是异步的

---
