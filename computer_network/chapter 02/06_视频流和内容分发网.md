# 视频流和内容分发网

## 英特网视频

视频是一系列的图像，通常以一种恒定的速率来展示。一副未压缩、数字编码的图像由像素阵列组成，其中每个像素是有一些比特编码来表示亮度和颜色。视频的一个重要特征，是他能够被压缩，因而可用比特率来和权衡视频的质量。今天现成的压缩算法能够将一个视频压缩长所希望的任何比特率，当然比特率越高，图像质量越好。

## HTTP和DASH

#### HTTP

客户通过HTTP GET向服务器请求数据，数据被储存在客户应用缓存中。一旦该缓存中的字节数量超过预先设定的门限，客户应用程序就开始播放。特别是，流式视频应用程序周期性的从客户应用程序缓存中抓取帧，对这些帧解压缩，并且在用户屏幕上展现，因此流逝视频应用接收到视频就进行播放，同时缓存该视频后面部分的帧。

#### DASH

DASH常被称为经HTTP的动态适应性流在DASH中视频编码为几个不同的版本，其中每个版本具有不同的比特率对应于不同的质量水平，客户动态的请求来自不同版本，且长度为几秒的视频段数据块。HTTP服务器有一个告示文件，为每个版本提供一个URL及其比特率。客户首先请求该告示文件，并且得知各种各样的版本，然后客户通过在HTTP GET请求报文中对每个块指定一个URL和一个字节范围，一次选择一块，在下载快的同时，客户也测量接收带宽，并运行一个速率决定算法来选择下次请求的块。DASH允许用户可以自由地在不同的质量等级之间切换。

## 内容分发网

为了应付向全世界的用户分发巨量视频数据的挑战，几乎所有主要的视频流公司都利用内容发布网（CDN）。CDN管理分布在多个地理位置上的服务器，在它的服务器中储存视频的副本，并且所有试图将每个各户请求定向到一个将提供最好的用户体验的CDN位置。

### CDN安置策略

当用户请求一个CDN集群中没有的视频时，该集群将检索该视频，在发送给用户时，在本地拷贝一份。当集群储存器变满时，它删除不经常请求的视频。

#### 深入

通过在遍及全球的接入ISP中部署服务器集群来深入到ISP的接入网中。靠近用户，改善用户体验到的时延和吞吐量。高度分布式设计，导致设计、维护和管理称为巨大挑战。

#### 邀请做客

在关键位置建造大集群来邀请ISP做客。这些CDN通常放置在英特网交换点。较低的维护管理开销，但有较高的时延和较低的吞吐量。

### CDN操作

当用户主机中的一个浏览器指令检索一个特定的视频是CDN，必须截获该请求，以便能够确定此时适合用于该用户的CDN服务器集群将客户的请求重新定向到该集群的某台服务器。

#### 重定向请求

1. 浏览器向服务器向video.netcinema.com请求Web视频
2. 本地DNS服务器向权威DNS服务器请求该主机名对应的IP
3. 权威DNS服务器检测到主机名中带有字符串video，则不返回其IP地址，而返回CDN域的主机名给本地DNS服务器
4. 本地DNS服务器向CND请求
5. CDN返回给本地DNS服务器客户请求的主机名对应的IP地址
6. 浏览器向该IP地址发出HTTP GET请求

### 集群选择策略

任何CDN部署其核心是集群选择策略，即动态的将客户定位到CDN中的某个服务器集群或数据中心的机制。

- 地理上最近的集群
- 时延和丢包性能最好的集群
